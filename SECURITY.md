# NodePass 安全增强文档

## 安全增强概述

本次更新为NodePass项目添加了全面的安全增强措施，主要解决两类安全威胁：

1. **中间人攻击**：通过证书固定、证书验证和安全握手协议，确保客户端只与合法服务器建立连接
2. **重放攻击**：通过时间戳、nonce和消息认证码，防止攻击者重放捕获的通信数据

这些安全措施在不影响原有功能的基础上，显著提高了NodePass的安全性，使其能够在不可信网络环境中安全运行。

## 安全特性详解

### 1. TLS 1.3 强制加密

- 所有加密连接均强制使用TLS 1.3，不再支持较低版本的TLS
- 限制密码套件仅使用TLS 1.3支持的安全套件
- 提供更好的前向安全性和更快的握手速度

### 2. 证书固定机制

- 实现了证书指纹计算和验证功能
- 客户端可以预先存储受信任服务器的证书指纹
- 连接时验证服务器证书指纹，防止中间人攻击

### 3. 安全握手协议

- 实现了双向认证的握手流程
- 交换加密参数和支持的协议信息
- 验证服务器身份和证书有效性

### 4. 防重放攻击机制

- 使用NonceManager跟踪已使用的nonce
- 每条消息包含唯一nonce和时间戳
- 拒绝处理重复nonce或过期时间戳的消息

### 5. 消息完整性验证

- 使用HMAC-SHA256计算消息认证码
- 验证消息完整性，防止消息被篡改
- 确保消息来源可信

### 6. 连接验证机制

- 实现连接令牌生成和验证
- 跟踪已验证的连接
- 防止会话劫持攻击

## 配置指南

### 启用安全特性

安全特性默认启用，无需额外配置。当使用TLS加密模式（tls=1或tls=2）时，系统将自动应用所有安全增强措施。

```bash
# 使用自签名证书和全部安全特性
nodepass "server://0.0.0.0:10101/127.0.0.1:8080?log=debug&tls=1"

# 使用自定义证书和全部安全特性
nodepass "server://0.0.0.0:10101/127.0.0.1:8080?log=debug&tls=2&crt=/path/to/cert.pem&key=/path/to/key.pem"
```

### 添加受信任证书

要添加受信任的证书指纹，可以使用以下方法：

1. 获取服务器证书指纹：

```bash
# 获取远程服务器证书指纹
openssl s_client -connect example.com:443 < /dev/null 2>/dev/null | \
  openssl x509 -fingerprint -sha256 -noout -in /dev/stdin
```

2. 在客户端配置中添加指纹：

```bash
# 在启动前设置环境变量
export NODEPASS_TRUSTED_CERTS="abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"

# 或者在代码中添加
nodepass "client://server.example.com:10101/127.0.0.1:8080?log=debug&trusted_certs=abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
```

## 安全最佳实践

1. **始终使用TLS加密**：即使在内部网络中，也应该启用TLS加密
2. **定期更新受信任证书**：定期检查和更新受信任的证书指纹
3. **使用长密钥**：对于自定义证书，使用至少2048位的RSA密钥或256位的ECC密钥
4. **启用日志记录**：设置log=debug以记录安全相关事件
5. **定期更新软件**：保持NodePass更新到最新版本，获取最新的安全修复

## 安全特性工作原理

### 证书固定流程

1. 服务器启动时加载证书
2. 计算证书的SHA-256指纹
3. 客户端连接时，服务器发送证书和指纹
4. 客户端验证证书指纹是否在受信任列表中
5. 如果指纹不匹配，客户端拒绝连接

### 安全握手流程

1. 客户端发送初始握手请求，包含nonce和支持的协议
2. 服务器验证请求，生成新nonce，发送响应
3. 客户端验证服务器响应，确认服务器身份
4. 双方建立加密通道，交换连接参数
5. 握手完成，开始安全通信

### 防重放保护机制

1. 发送方为每条消息生成唯一nonce
2. 消息包含nonce、时间戳和数据
3. 计算整个消息的HMAC
4. 接收方验证HMAC、检查nonce是否已使用、验证时间戳是否在有效期内
5. 如果验证通过，处理消息并记录nonce

## 安全性验证

所有安全特性都经过了全面测试，包括：

1. 证书指纹验证测试
2. 安全握手协议测试
3. 防重放攻击机制测试
4. 连接验证器测试

这些测试确保了安全特性能够有效防御中间人攻击和重放攻击。
